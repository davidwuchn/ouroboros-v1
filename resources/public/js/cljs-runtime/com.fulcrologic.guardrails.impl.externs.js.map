{"version":3,"sources":["com/fulcrologic/guardrails/impl/externs.cljc"],"mappings":"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","names":["js/com","js/com.fulcrologic","js/com.fulcrologic.guardrails","js/com.fulcrologic.guardrails.impl","js/com.fulcrologic.guardrails.impl.externs","js/com.fulcrologic.guardrails.impl.externs.externs-registry","com.fulcrologic.guardrails.impl.externs/externs-registry","cljs.core.atom","js/com.fulcrologic.guardrails.impl.externs.spec-registry","com.fulcrologic.guardrails.impl.externs/spec-registry","js/com.fulcrologic.guardrails.impl.externs.function-registry","com.fulcrologic.guardrails.impl.externs/function-registry","js/com.fulcrologic.guardrails.impl.externs.external-function-registry","com.fulcrologic.guardrails.impl.externs/external-function-registry","com.fulcrologic.guardrails.impl.externs/register-externs!","NS","fn-name","externs","cljs.core.swap_BANG_","cljs.core/assoc-in","com.fulcrologic.guardrails.impl.externs/register-specs!","function","cljs.core/merge","com.fulcrologic.guardrails.impl.externs/clean-function","cljs.core.update","p1__35586#","cljs.core.partial","com.fulcrologic.guardrails.utils/map-vals","cljs.core.dissoc","com.fulcrologic.guardrails.impl.externs/register-function!","p__35627","map__35631","cljs.core/--destructure-map","cljs.core.get","com.fulcrologic.guardrails.impl.externs/record-defn!","p__35638","map__35639","com.fulcrologic.guardrails.impl.externs/register-external-function!","external-function","var-name","cljs.core/assoc","com.fulcrologic.guardrails.impl.externs/record-fdef!","com.fulcrologic.guardrails.impl.externs/function-info","qualified-symbol","spc","cljs.core/namespace","simple-name","cljs.core.symbol","cljs.core/name","or__5002__auto__","cljs.core/deref","cljs.core.get_in","com.fulcrologic.guardrails.impl.externs/pure?","arity","cljs.core/boolean","map__35653","info","has-arity?","pure","pure?","com.fulcrologic.guardrails.impl.externs/spec-system","map__35657","spec-system","com.fulcrologic.guardrails.impl.externs/get-externs","fn-sym","ns-str","name-sym","com.fulcrologic.guardrails.impl.externs/in-scope?","sym","scope-ns-prefixes","temp__5825__auto__","ns","p1__35715#","cljs.core/some","clojure.string/starts-with?","com.fulcrologic.guardrails.impl.externs/direct-calls","cljs.core/vals","cljs.core.remove","cljs.core.map","quoted-sym","cljs.core/seq?","cljs.core._EQ_","cljs.core/first","cljs.core/second","p1__35738#","cljs.core.filter","p1__35739#","cljs.core.into","com.fulcrologic.guardrails.impl.externs/all-in-scope-functions","cljs.core.mapcat","p__35749","vec__35750","cljs.core.nth","fns","p1__35748#","p__35753","vec__35754","_","com.fulcrologic.guardrails.impl.externs/transitive-calls","to-visit","visited","cljs.core/empty?","current","calls","cljs.core.disj","cljs.core.conj","com.fulcrologic.guardrails.impl.externs/call-graph","all-fns","iter__5480__auto__","s__35769","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__5478__auto__","size__5479__auto__","cljs.core/count","b__35771","cljs.core/chunk-buffer","i__35770","cljs.core/-nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__35768","cljs.core/chunk-rest","cljs.core/cons","cljs.core/rest","cljs.core/chunk-first"],"sourcesContent":["(ns com.fulcrologic.guardrails.impl.externs\n  (:require\n    #?@(:clj [[clojure.walk :as walk]])\n    [com.fulcrologic.guardrails.registry :as gr.reg]\n    [com.fulcrologic.guardrails.utils :as utils]))\n\n(defonce externs-registry (atom {}))\n(defonce spec-registry (atom {}))\n(defonce function-registry (atom {}))\n(defonce external-function-registry (atom {}))\n\n#?(:clj (try (require 'cljs.analyzer.api) (catch Exception _)))\n\n#?(:clj\n   (defn compiling-cljs? [env]\n     (and (:ns env) (utils/compiling-cljs?))))\n\n#?(:clj\n   (defn cljc-resolve [env s]\n     (letfn [(cljs-resolve []\n               (let [rslv     (some-> (find-ns 'cljs.analyzer.api) (ns-resolve 'resolve))\n                     ast-node (when rslv (rslv env s))\n                     macro?   (boolean (:macro ast-node))]\n                 (when ast-node\n                   (cond-> {::gr.reg/extern-name `(quote ~(:name ast-node))\n                            ::gr.reg/macro?      macro?}\n                     (not macro?) (assoc ::gr.reg/extern-value s)))))\n             (clojure-resolve []\n               (if (contains? env s)\n                 {::gr.reg/extern-name  `(quote ~s)\n                  ::gr.reg/extern-value s}\n                 (let [sym-var (ns-resolve *ns* env s)\n                       cls?    (class? sym-var)\n                       macro?  (boolean (some-> sym-var meta :macro))]\n                   (when (and sym-var (not cls?))\n                     (cond-> {::gr.reg/extern-name `(quote ~(symbol sym-var))\n                              ::gr.reg/macro?      macro?}\n                       (not macro?)\n                       (assoc ::gr.reg/extern-value (symbol sym-var)))))))]\n       (if (compiling-cljs? env)\n         (cljs-resolve)\n         (clojure-resolve)))))\n\n#?(:clj\n   (defn extern-symbols [env body]\n     (let [externs (atom {})\n           record! (fn [x]\n                     (when (symbol? x)\n                       (when-let [extern (cljc-resolve env x)]\n                         (swap! externs assoc `(quote ~x) extern)))\n                     x)]\n       (walk/postwalk record! body)\n       @externs)))\n\n(defn register-externs! [NS fn-name externs]\n  (swap! externs-registry assoc-in [NS fn-name] externs))\n\n(defn register-specs! [function]\n  (swap! spec-registry merge (::gr.reg/spec-registry function)))\n\n(defn clean-function [function]\n  (-> function\n    (update ::gr.reg/arities\n      (partial utils/map-vals #(dissoc % ::gr.reg/body)))\n    (dissoc ::gr.reg/spec-registry)))\n\n(defn register-function! [NS fn-name function]\n  (register-specs! function)\n  (swap! function-registry assoc-in [NS fn-name]\n    (clean-function function)))\n\n(defn record-defn! [NS {:as function ::gr.reg/keys [fn-name]} externs]\n  (register-externs! NS fn-name externs)\n  (register-function! NS fn-name function))\n\n(defn register-external-function! [{:as external-function ::gr.reg/keys [var-name]}]\n  (swap! external-function-registry assoc var-name\n    (clean-function external-function)))\n\n(defn record-fdef! [external-function]\n  (register-specs! external-function)\n  (register-external-function! external-function))\n\n(defn function-info\n  \"Returns the information known about the given qualified symbol (if it was declared with >defn in\n  copilot mode, or has register a gspec on an external function) .\"\n  [qualified-symbol]\n  (let [spc         (namespace qualified-symbol)\n        simple-name (symbol (name qualified-symbol))]\n    (or\n      (get @external-function-registry qualified-symbol)\n      (get-in @function-registry [spc simple-name]))))\n\n(defn pure?\n  \"Returns true if the given fully-qualified symbol was declared with >defn and the arity (which is a number\n   or :n) is marked as pure.\"\n  [qualified-symbol arity]\n  (boolean\n    (let [info       (function-info qualified-symbol)\n          has-arity? (boolean (get-in info [::gr.reg/arities arity]))\n          {:keys [pure pure?]} (get-in info [::gr.reg/arities (if has-arity? arity :n) ::gr.reg/gspec ::gr.reg/metadata])]\n      (or pure pure?))))\n\n(defn spec-system\n  \"Returns the function spec system that was used in the type signature of the given symbol, or nil if that\n   function isn't registered with guardrails.\"\n  [qualified-symbol]\n  (let [{::gr.reg/keys [spec-system] :as info} (function-info qualified-symbol)]\n    (when info\n      (or spec-system :org.clojure/spec1))))\n\n#?(:clj\n   (defn run-registry-function\n     \"Run the given function defined by the qualified-symbol if and only if that arity of the function is pure.\n\n      qualified-symbol - The symbol of the function\n      args - a vector of arguments to pass to it.\n\n      Throws IllegalArgumentException if that function arity is not marked pure.\"\n     [qualified-symbol args]\n     (if (pure? qualified-symbol (count args))\n       (let [{::gr.reg/keys [fn-ref]} (function-info qualified-symbol)]\n         (apply fn-ref args))\n       (throw (IllegalArgumentException. (str qualified-symbol \" is not a pure function.\"))))))\n\n;; ============================================================================\n;; Call Graph Analysis\n;; ============================================================================\n\n(defn get-externs\n  \"Returns the externs map for the given qualified function symbol, or nil if not found.\"\n  [fn-sym]\n  (let [ns-str   (namespace fn-sym)\n        name-sym (symbol (name fn-sym))]\n    (get-in @externs-registry [ns-str name-sym])))\n\n(defn in-scope?\n  \"Returns true if the symbol's namespace starts with one of the scope prefixes.\"\n  [sym scope-ns-prefixes]\n  (when-let [ns (namespace sym)]\n    (some #(clojure.string/starts-with? ns %) scope-ns-prefixes)))\n\n(defn direct-calls\n  \"Returns set of qualified symbols that fn-sym directly calls within scope.\n   Only includes functions that are in the function-registry (guardrailed functions)\n   AND whose namespace matches one of the scope-ns-prefixes.\n   Excludes the function itself (self-references from >defn processing).\n\n   fn-sym - Fully qualified symbol of the function\n   scope-ns-prefixes - Set of namespace prefix strings to include (e.g. #{\\\"myapp\\\"})\"\n  [fn-sym scope-ns-prefixes]\n  (when-let [externs (get-externs fn-sym)]\n    (->> externs\n      (vals)\n      (remove ::gr.reg/macro?)\n      (map ::gr.reg/extern-name)\n      (map (fn [quoted-sym]\n             ;; extern-name is stored as (quote sym)\n             (if (and (seq? quoted-sym) (= 'quote (first quoted-sym)))\n               (second quoted-sym)\n               quoted-sym)))\n      (filter #(in-scope? % scope-ns-prefixes))\n      (remove #(= % fn-sym))                                ;; Exclude self-references\n      (into #{}))))\n\n(defn all-in-scope-functions\n  \"Returns all function symbols defined with guardrails in namespaces matching scope prefixes.\"\n  [scope-ns-prefixes]\n  (->> @function-registry\n    (mapcat (fn [[ns-str fns]]\n              (when (some #(clojure.string/starts-with? ns-str %) scope-ns-prefixes)\n                (map (fn [[fn-name _]]\n                       (symbol ns-str (str fn-name)))\n                  fns))))\n    (into #{})))\n\n(defn transitive-calls\n  \"Returns all functions transitively called by fn-sym within scope.\n   Includes fn-sym itself. Only includes guardrailed functions in scope.\n\n   fn-sym - Fully qualified symbol of the function\n   scope-ns-prefixes - Set of namespace prefix strings to include\"\n  [fn-sym scope-ns-prefixes]\n  (loop [to-visit #{fn-sym}\n         visited  #{}]\n    (if (empty? to-visit)\n      visited\n      (let [current (first to-visit)\n            calls   (or (direct-calls current scope-ns-prefixes) #{})]\n        (recur (into (disj to-visit current) (remove visited calls))\n          (conj visited current))))))\n\n(defn call-graph\n  \"Returns a map of {fn-sym -> #{called-fn-syms}} for all guardrailed functions\n   in the given namespace scope.\n\n   scope-ns-prefixes - Set of namespace prefix strings to include\"\n  [scope-ns-prefixes]\n  (let [all-fns (all-in-scope-functions scope-ns-prefixes)]\n    (into {}\n      (for [fn-sym all-fns]\n        [fn-sym (direct-calls fn-sym scope-ns-prefixes)]))))\n"],"x_google_ignoreList":[0]}