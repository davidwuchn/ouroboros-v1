{"version":3,"sources":["ouroboros/frontend/websocket.cljs"],"mappings":"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","names":["js/ouroboros","js/ouroboros.frontend","js/ouroboros.frontend.websocket","js/ouroboros.frontend.websocket.ws-connection","ouroboros.frontend.websocket/ws-connection","cljs.core.atom","js/ouroboros.frontend.websocket.reconnect-timeout","ouroboros.frontend.websocket/reconnect-timeout","js/ouroboros.frontend.websocket.reconnect-attempts","ouroboros.frontend.websocket/reconnect-attempts","js/ouroboros.frontend.websocket.subscribed-topics","ouroboros.frontend.websocket/subscribed-topics","ouroboros.frontend.websocket/max-reconnect-attempts","ouroboros.frontend.websocket/reconnect-delay-ms","js/ouroboros.frontend.websocket.handle-message","method-table__5599__auto__","prefer-table__5600__auto__","method-cache__5601__auto__","cached-hierarchy__5602__auto__","hierarchy__5603__auto__","cljs.core.get","fexpr__40868","cljs.core/MultiFn","cljs.core.symbol","ouroboros.frontend.websocket/handle-message","message","js/console.log","cljs.core/keys","cljs.core/clj->js","p__40870","map__40871","cljs.core/--destructure-map","client-id","timestamp","p__40873","map__40875","data","temp__5825__auto__","cljs.core/deref","app","com.fulcrologic.fulcro.application/app","com.fulcrologic.fulcro.algorithms.merge/merge!","p__40877","map__40878","session-id","p__40881","map__40883","ouroboros.frontend.websocket/get-ws-url","protocol","cljs.core._EQ_","js/window.location.protocol","host","js/window.location.host","port","js/window.location.port","js/window.location.hostname","cljs.core/seq","ouroboros.frontend.websocket/connect!","e40892","cljs.core.swap_BANG_","cljs.core/inc","ws","js/WebSocket","cljs.core/reset!","js/JSON.stringify","event","e40896","json-data","parsed","js/JSON.parse","cljs.core/object?","cljs.core/array?","cljs.core.js__GT_clj","cljs.core.update","cljs.core/keyword","js/console.warn","js/Error","e","js/console.error","js/setTimeout","error","ouroboros.frontend.websocket/disconnect!","timeout","js/clearTimeout","ouroboros.frontend.websocket/send!","js/WebSocket.OPEN","ouroboros.frontend.websocket/send-subscription!","type","topic","ouroboros.frontend.websocket/subscribe!","and__5000__auto__","ouroboros.frontend.websocket/connected?","cljs.core/contains?","cljs.core/conj","ouroboros.frontend.websocket/unsubscribe!","cljs.core/disj","ouroboros.frontend.websocket/subscribe-builder-session!","ouroboros.frontend.websocket/unsubscribe-builder-session!","ouroboros.frontend.websocket/ping!","js/ouroboros.frontend.websocket.ping-interval","ouroboros.frontend.websocket/ping-interval","ouroboros.frontend.websocket/start-ping-loop!","ouroboros.frontend.websocket/stop-ping-loop!","js/setInterval","interval","js/clearInterval","ouroboros.frontend.websocket/init!","ouroboros.frontend.websocket/destroy!","ouroboros.frontend.websocket/status"],"sourcesContent":["(ns ouroboros.frontend.websocket\n  \"WebSocket client for real-time updates\"\n  (:require\n   [com.fulcrologic.fulcro.application :as app]\n   [com.fulcrologic.fulcro.algorithms.merge :as merge]))\n\n;; ============================================================================\n;; Connection State\n;; ============================================================================\n\n(defonce ws-connection (atom nil))\n(defonce reconnect-timeout (atom nil))\n(defonce reconnect-attempts (atom 0))\n(defonce subscribed-topics (atom #{}))  ;; Track topics we're subscribed to\n\n(def max-reconnect-attempts 5)\n(def reconnect-delay-ms 3000)\n\n;; ============================================================================\n;; Message Handlers\n;; ============================================================================\n\n(defmulti handle-message :type)\n\n(defmethod handle-message :default\n  [message]\n  (js/console.log \"Unknown WebSocket message type:\" (:type message))\n  (js/console.log \"Full message keys:\" (keys message))\n  (js/console.log \"Full message:\" (clj->js message)))\n\n(defmethod handle-message :connected\n  [{:keys [client-id timestamp]}]\n  (js/console.log \"WebSocket connected, client ID:\" client-id))\n\n(defmethod handle-message :telemetry/event\n  [{:keys [data]}]\n  (js/console.log \"Telemetry event received:\" data)\n  ;; Merge into app state - add to events list\n  (when-let [app @app/app]\n    (merge/merge! app\n                  {:page/id :telemetry\n                   :telemetry/events [data]})))\n\n(defmethod handle-message :builder-session/update\n  [{:keys [session-id data]}]\n  (js/console.log \"Builder session update received:\" session-id data)\n  ;; Merge into app state - update session data\n  (when-let [app @app/app]\n    ;; Find which builder page this belongs to and update its session/data\n    ;; For now, we'll update a global location; pages can watch this\n    (merge/merge! app\n                  {:page/id :builder-session-update\n                   :builder-session/id session-id\n                   :builder-session/data data})))\n\n(defmethod handle-message :pong\n  [{:keys [timestamp]}]\n  ;; Keep connection alive\n  nil)\n\n;; ============================================================================\n;; Connection Management\n;; ============================================================================\n\n(defn- get-ws-url\n  \"Get WebSocket URL based on current location\n   \n   In development, Shadow-CLJS serves on port 8081 but WebSocket server is on 8080.\n   We detect this and use the correct port.\"\n  []\n  (let [protocol (if (= js/window.location.protocol \"https:\") \"wss:\" \"ws:\")\n        host js/window.location.host\n        port js/window.location.port]\n    (str protocol \"//\"\n         js/window.location.hostname\n         (if (= port \"8081\")\n           \":8080\"  ; Development: Shadow-CLJS on 8081, API on 8080\n           (if (seq port) (str \":\" port) \"\"))\n         \"/ws\")))\n\n(defn connect!\n  \"Establish WebSocket connection\"\n  []\n  (when-not @ws-connection\n    (try\n      ;; Mark that we're attempting a connection\n      (swap! reconnect-attempts inc)\n      (let [ws (js/WebSocket. (get-ws-url))]\n        (set! (.-onopen ws)\n              (fn []\n                (js/console.log \"WebSocket connection opened\")\n                (reset! reconnect-attempts 0)\n                ;; Subscribe to telemetry events\n                (.send ws (js/JSON.stringify\n                           #js {:type \"subscribe\"\n                                :topic \"telemetry/events\"}))))\n\n        (set! (.-onmessage ws)\n              (fn [event]\n                (try\n                  (let [json-data (.-data event)]\n                    (js/console.log \"WebSocket raw JSON:\" json-data)\n                    (let [parsed (js/JSON.parse json-data)]\n                      (js/console.log \"WebSocket parsed JS object:\" parsed)\n                      ;; Check if parsed is a JS object (not array)\n                      (if (and (object? parsed) (not (array? parsed)))\n                        (let [data (js->clj parsed :keywordize-keys true)\n                              ;; Ensure :type is a keyword for multimethod dispatch\n                              data (if (:type data)\n                                     (update data :type keyword)\n                                     data)]\n                          (js/console.log \"WebSocket CLJS data:\" data)\n                          (if (:type data)\n                            (handle-message data)\n                            (js/console.warn \"WebSocket message missing :type:\" data)))\n                        (js/console.warn \"WebSocket received non-object message:\" parsed))))\n                  (catch js/Error e\n                    (js/console.error \"WebSocket message error:\" e)))))\n\n        (set! (.-onclose ws)\n              (fn [event]\n                (js/console.log \"WebSocket connection closed\")\n                (reset! ws-connection nil)\n                ;; Attempt reconnection if we were previously connected\n                (when (and (> @reconnect-attempts 0)\n                           (< @reconnect-attempts max-reconnect-attempts))\n                  (swap! reconnect-attempts inc)\n                  (js/console.log \"WebSocket reconnect attempt\" @reconnect-attempts \"/\" max-reconnect-attempts)\n                  (reset! reconnect-timeout\n                          (js/setTimeout connect! reconnect-delay-ms)))))\n\n        (set! (.-onerror ws)\n              (fn [error]\n                ;; Only log as warning - backend may not be running\n                (js/console.warn \"WebSocket connection failed (backend may not be running)\")))\n\n        (reset! ws-connection ws))\n      (catch js/Error e\n        (js/console.error \"WebSocket connection error:\" e)))))\n\n(defn disconnect!\n  \"Close WebSocket connection\"\n  []\n  (when-let [timeout @reconnect-timeout]\n    (js/clearTimeout timeout)\n    (reset! reconnect-timeout nil))\n  (when-let [ws @ws-connection]\n    (.close ws)\n    (reset! ws-connection nil)\n    (js/console.log \"WebSocket disconnected\")))\n\n(defn send!\n  \"Send message via WebSocket\"\n  [message]\n  (when-let [ws @ws-connection]\n    (when (= (.-readyState ws) js/WebSocket.OPEN)\n      (.send ws (js/JSON.stringify (clj->js message))))))\n\n(defn- send-subscription!\n  \"Send subscription/unsubscription message\"\n  [type topic]\n  (send! {:type type :topic topic}))\n\n(defn subscribe!\n  \"Subscribe to a WebSocket topic\"\n  [topic]\n  (when (and (connected?) (not (contains? @subscribed-topics topic)))\n    (send-subscription! \"subscribe\" topic)\n    (swap! subscribed-topics conj topic)\n    (js/console.log \"Subscribed to topic:\" topic)))\n\n(defn unsubscribe!\n  \"Unsubscribe from a WebSocket topic\"\n  [topic]\n  (when (and (connected?) (contains? @subscribed-topics topic))\n    (send-subscription! \"unsubscribe\" topic)\n    (swap! subscribed-topics disj topic)\n    (js/console.log \"Unsubscribed from topic:\" topic)))\n\n(defn subscribe-builder-session!\n  \"Subscribe to builder session updates\"\n  [session-id]\n  (let [topic (str \"builder-session/\" session-id)]\n    (subscribe! topic)))\n\n(defn unsubscribe-builder-session!\n  \"Unsubscribe from builder session updates\"\n  [session-id]\n  (let [topic (str \"builder-session/\" session-id)]\n    (unsubscribe! topic)))\n\n(defn ping!\n  \"Send ping to keep connection alive\"\n  []\n  (send! {:type :ping}))\n\n;; ============================================================================\n;; Health Check\n;; ============================================================================\n\n(defonce ping-interval (atom nil))\n\n(defn start-ping-loop!\n  \"Start periodic ping to keep connection alive\"\n  []\n  (stop-ping-loop!)\n  (reset! ping-interval\n          (js/setInterval ping! 30000))) ;; Ping every 30 seconds\n\n(defn stop-ping-loop!\n  \"Stop ping loop\"\n  []\n  (when-let [interval @ping-interval]\n    (js/clearInterval interval)\n    (reset! ping-interval nil)))\n\n;; ============================================================================\n;; Lifecycle\n;; ============================================================================\n\n(defn init!\n  \"Initialize WebSocket connection\"\n  []\n  (connect!)\n  (start-ping-loop!))\n\n(defn destroy!\n  \"Clean up WebSocket connection\"\n  []\n  (stop-ping-loop!)\n  (disconnect!))\n\n;; ============================================================================\n;; Status\n;; ============================================================================\n\n(defn connected?\n  \"Check if WebSocket is connected\"\n  []\n  (and @ws-connection\n       (= (.-readyState @ws-connection) js/WebSocket.OPEN)))\n\n(defn status\n  \"Get WebSocket status\"\n  []\n  {:connected (connected?)\n   :reconnect-attempts @reconnect-attempts})\n"]}