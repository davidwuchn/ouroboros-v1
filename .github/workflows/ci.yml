name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Babashka
      uses: turtlequeue/setup-babashka@v1.7.0
      with:
        babashka-version: 1.12.195
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-bb-${{ hashFiles('bb.edn') }}
        restore-keys: |
          ${{ runner.os }}-bb-
    
    - name: Run tests
      run: bb test
    
    - name: Check formatting
      run: |
        echo "◈ Checking code formatting..."
        # Find all .clj files and check they're valid
        find src test -name "*.clj" -exec bb -cp '{}' -e "(println 'OK {})" \;
    
    - name: Verify bb tasks
      run: |
        echo "◈ Available tasks:"
        bb tasks

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ouroboros:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        echo "◈ Testing Docker image..."
        docker run --rm ouroboros:test bb tasks
        docker run --rm ouroboros:test bb config

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Babashka
      uses: turtlequeue/setup-babashka@v1.7.0
      with:
        babashka-version: 1.12.195
    
    - name: Run clj-kondo lint
      run: |
        echo "◈ Running clj-kondo..."
        if command -v clj-kondo &> /dev/null; then
          clj-kondo --lint src test
        else
          echo "⚠️ clj-kondo not installed, skipping lint"
          bb -cp src -e "(println 'Lint check skipped)"
        fi
    
    - name: Check for secrets
      run: |
        echo "◈ Checking for secrets..."
        # Check for common secret patterns
        ERRORS=0
        
        # OpenAI keys (sk-...)
        if grep -rE "sk-[a-zA-Z0-9]{20,}" src/ test/ --include="*.clj" 2>/dev/null | grep -v "example\|test\|fake\|placeholder"; then
          echo "⚠️ Possible OpenAI API key found"
          ERRORS=$((ERRORS + 1))
        fi
        
        # Slack tokens (xapp-, xoxb-, xoxp-)
        if grep -rE "x(app|ox[bpa])-[0-9]{10,}" src/ test/ --include="*.clj" 2>/dev/null | grep -v "example\|test\|fake"; then
          echo "⚠️ Possible Slack token found"
          ERRORS=$((ERRORS + 1))
        fi
        
        # Discord tokens (64+ char alphanumeric)
        if grep -rE "[A-Za-z0-9_-]{64,}" src/ test/ --include="*.clj" 2>/dev/null | grep -i "discord\|bot.*token" | grep -v "example\|test\|fake"; then
          echo "⚠️ Possible Discord token found"
          ERRORS=$((ERRORS + 1))
        fi
        
        # AWS keys (AKIA...)
        if grep -rE "AKIA[0-9A-Z]{16}" src/ test/ --include="*.clj" 2>/dev/null; then
          echo "⚠️ Possible AWS access key found"
          ERRORS=$((ERRORS + 1))
        fi
        
        if [ $ERRORS -gt 0 ]; then
          echo "✗ Found $ERRORS potential secret(s)"
          exit 1
        fi
        
        echo "✓ No obvious secrets found"
