name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Babashka
      uses: turtlequeue/setup-babashka@v1.7.0
      with:
        babashka-version: 1.12.195
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-bb-${{ hashFiles('bb.edn') }}
        restore-keys: |
          ${{ runner.os }}-bb-
    
    - name: Run tests
      run: bb test
    
    - name: Check formatting
      run: |
        echo "◈ Checking code formatting..."
        # Find all .clj files and check they're valid
        find src test -name "*.clj" -exec bb -cp '{}' -e "(println 'OK {})" \;
    
    - name: Verify bb tasks
      run: |
        echo "◈ Available tasks:"
        bb tasks

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ouroboros:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker image
      run: |
        echo "◈ Testing Docker image..."
        docker run --rm ouroboros:test bb tasks
        docker run --rm ouroboros:test bb config

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Babashka
      uses: turtlequeue/setup-babashka@v1.7.0
      with:
        babashka-version: 1.12.195
    
    - name: Run clj-kondo lint
      run: |
        echo "◈ Running clj-kondo..."
        if command -v clj-kondo &> /dev/null; then
          clj-kondo --lint src test
        else
          echo "⚠️ clj-kondo not installed, skipping lint"
          bb -cp src -e "(println 'Lint check skipped)"
        fi
    
    - name: Check for secrets
      run: |
        echo "◈ Checking for secrets..."
        # Basic check for common secret patterns
        if grep -r "sk-" src/ test/ --include="*.clj" 2>/dev/null | grep -v "example\|test\|fake"; then
          echo "⚠️ Possible API key found in source"
          exit 1
        fi
        echo "✓ No obvious secrets found"
