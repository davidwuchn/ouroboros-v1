{:deps {;; Engine (∅) -> substrate: explicit, queryable state machines
        com.fulcrologic/statecharts                   {:mvn/version "1.2.25"}
        ;; Query + Graph: EQL interface to everything
        com.wsscode/pathom3                           {:mvn/version "2025.01.16-alpha"}
        ;; API: OpenAPI specs -> callable clients
        com.github.oliyh/martian-babashka-http-client {:mvn/version "0.2.1"}
        org.babashka/http-client                      {:mvn/version "0.4.23"}}

 :paths ["src"]

 :tasks
 {:requires ([clojure.string :as str]
             [babashka.process :refer [shell process]])
  ;; ==========================================================================
  ;; Core Tasks
  ;; ==========================================================================
  ;; nREPL convention: port 8888 (use 888X for parallel playthroughs)

  boot
  {:doc "Boot the Ouroboros system (Engine + Query)"
   :requires ([ouroboros.interface :as iface])
   :task (do (println "◈ Booting Ouroboros system...")
             (iface/boot!)
             (println "\n✓ System ready")
             (println "  Query: (iface/q [:system/status])")
             (println "  Status: (iface/status)"))}

  nrepl
  {:doc "Start nREPL on port 8888 with system pre-booted"
   :requires ([babashka.nrepl.server :as nrepl]
              [ouroboros.interface :as iface])
   :task (do (println "◈ Booting system...")
             (iface/boot!)
             (println "◈ Starting nREPL on port 8888...")
             (println "  Pre-loaded: ouroboros.interface")
             (println "  Try: (iface/q [:system/status])")
             (nrepl/start-server! {:host "localhost"
                                   :port 8888})
             (deref (promise)))}

  chat
  {:doc "Start chat bot (requires TELEGRAM_BOT_TOKEN and OPENAI_API_KEY env vars)"
   :requires ([ouroboros.interface :as iface])
   :task (let [token (System/getenv "TELEGRAM_BOT_TOKEN")
               api-key (System/getenv "OPENAI_API_KEY")]
           (cond
             (str/blank? token)
             (do (println "✗ TELEGRAM_BOT_TOKEN not set")
                 (println "  Get token from @BotFather")
                 (System/exit 1))
             
             (str/blank? api-key)
             (do (println "✗ OPENAI_API_KEY not set")
                 (println "  Get key from https://platform.openai.com")
                 (System/exit 1))
             
             :else
             (do (println "◈ Booting system...")
                 (iface/boot!)
                 (println "◈ Configuring AI agent...")
                 (iface/agent-configure! {:provider :openai :api-key api-key})
                 (println "◈ Registering Telegram bot...")
                 (iface/chat-register-telegram! token)
                 (println "◈ Starting chat adapters...")
                 (iface/chat-start!)
                 (println "✓ Chat bot running. Press Ctrl+C to stop.")
                 (deref (promise)))))}}}
