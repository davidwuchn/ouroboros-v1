{:deps {com.fulcrologic/statecharts                   {:mvn/version "1.2.25"}
        com.wsscode/pathom3                           {:mvn/version "2025.01.16-alpha"}
        com.github.oliyh/martian-babashka-http-client {:mvn/version "0.2.1"}
        org.babashka/http-client                      {:mvn/version "0.4.23"}
        cheshire/cheshire                             {:mvn/version "5.13.0"}
        http-kit/http-kit                             {:mvn/version "2.8.0"}}

 :paths ["src" "test" "src/frontend"]

 :tasks
 {:requires ([clojure.string :as str]
             [babashka.process :refer [shell]])

  ;; === Core ===

  boot
  {:doc "Boot the Ouroboros system"
   :requires ([ouroboros.interface :as iface])
   :task (do (iface/boot!)
             (println "System ready: (iface/q [:system/status])"))}

  nrepl
  {:doc "Start nREPL on port 8888 (tmux: proc-nrepl)"
   :requires ([ouroboros.process-runner :as pr])
   :task (do (pr/start-or-ignore! "nrepl" "bb nrepl:server")
             (pr/logs "nrepl" :follow? true))}

  nrepl:server
  {:doc "Internal: nREPL server (port 8888)"
   :requires ([babashka.nrepl.server :as nrepl]
              [ouroboros.interface :as iface])
   :task (let [port 8888]
           (iface/boot!)
           (nrepl/start-server! {:host "localhost" :port port})
           (println "nREPL listening on port" port)
           (deref (promise)))}

  chat
  {:doc "Start chat bots from environment"
   :requires ([ouroboros.config :as config])
   :task (config/start-from-env!)}

  ;; === Dashboard & Frontend ===

  dashboard
  {:doc "Start dashboard server (tmux: proc-dashboard)"
   :requires ([ouroboros.process-runner :as pr])
   :task (do (pr/start-or-ignore! "dashboard" "clojure -M -m ouroboros.dashboard")
             (pr/logs "dashboard" :follow? true))}

  frontend:dev
  {:doc "Start shadow-cljs dev server (tmux: proc-frontend-dev)"
   :requires ([ouroboros.process-runner :as pr])
   :task (do (pr/start-or-ignore! "frontend-dev" "npx shadow-cljs watch dashboard")
             (pr/logs "frontend-dev" :follow? true))}

  frontend:build
  {:doc "Build frontend for production"
   :task (shell "npx shadow-cljs release dashboard")}

  frontend:install
  {:doc "Install npm dependencies"
   :task (shell "npm install")}

  ;; === Dev Stack ===

  dev
  {:doc "Start full dev stack (blocking, Ctrl+C to stop)"
   :requires ([ouroboros.dev :as dev])
   :task (dev/start-stack!)}

  dev:start
  {:doc "Start dev stack (non-blocking, returns immediately)"
   :requires ([ouroboros.dev :as dev])
   :task (dev/start-stack-detached!)}

  dev:stop
  {:doc "Stop dev stack"
   :requires ([ouroboros.process-runner :as pr])
   :task (doseq [proc ["ouroboros-backend" "ouroboros-frontend"]]
           (if (pr/stop! proc)
             (println proc "stopped")
             (println proc "was not running")))}

  ;; === Process Management ===

  process
  {:doc "Manage processes (start, stop, logs, attach)"
   :requires ([ouroboros.process-runner])
   :task (apply ouroboros.process-runner/-main *command-line-args*)}

  ;; === Utilities ===

  config
  {:doc "Show configuration"
   :requires ([ouroboros.config :as config])
   :task (do (config/load-config!)
             (clojure.pprint/pprint (config/config-summary)))}

  git:install-hooks
  {:doc "Install git hooks"
   :task (let [source "scripts/git-hooks/pre-commit"
               target ".git/hooks/pre-commit"]
           (if (babashka.fs/exists? source)
             (do (babashka.fs/copy source target {:replace-existing true})
                 (babashka.fs/set-posix-file-permissions target "rwxr-xr-x")
                 (println "Pre-commit hook installed"))
             (println "Hook source not found:" source)))}

  audit:ns
  {:doc "Audit namespace dependencies"
   :task (shell "bb scripts/ns-audit.clj")}

  download
  {:doc "Fast download with auto-resume"
   :task (let [args *command-line-args*]
           (if (seq args)
             (apply shell "bb" "scripts/fast-download.clj" args)
             (do (println "Usage: bb download <url> [file] [-c 16]")
                 (println "  -c N  Connections (default: 16)"))))}

  setup
  {:doc "Setup tasks: bb setup:eca"
   :task (println "Setup commands:\n  bb setup:eca  - Install ECA binary for AI chat")}

  setup:eca
  {:doc "Install ECA binary for AI chat features"
   :task (let [prefix (first *command-line-args*)]
           (if prefix
             (shell "bb" "scripts/install-eca.clj" prefix)
             (shell "bb" "scripts/install-eca.clj")))}

  eca:diagnose
  {:doc "Diagnose ECA startup issues"
   :task (shell "bb" "scripts/eca-diagnose.clj")}

  eca:status
  {:doc "Show ECA process status (our process vs orphaned)"
   :requires ([ouroboros.eca-client :as eca])
   :task (eca/print-process-status)}

  ;; === Testing ===

  test
  {:doc "Run all tests"
   :requires ([ouroboros.test-runner :as tr])
   :task (tr/run-suites
          "Running Tests"
          ['ouroboros.core-test
           'ouroboros.chat-adapter-test
           'ouroboros.chat-commands-test
           'ouroboros.workflow-test
           'ouroboros.knowledge-test
           'ouroboros.streaming-test
           'ouroboros.tool-execution-test
           'ouroboros.integration-test])}

  test:webux
  {:doc "Run WebUX tests (requires Clojure)"
   :task (shell "clojure -M -e \"(load-file \\\"scripts/test_webux_jvm.clj\\\") ((resolve 'scripts.test-webux-jvm/-main))\"")}

  test:eca
  {:doc "Run ECA integration tests"
   :requires ([ouroboros.test-runner :as tr])
   :task (tr/run-suites
          "ECA Tests"
          ['ouroboros.eca-client-test
           'ouroboros.eca-approval-bridge-test
           'ouroboros.eca-integration-test
           'ouroboros.eca-protocol-test
           'ouroboros.eca-websocket-integration-test])}

  ;; === Debug ===

  debug
  {:doc "Debug utilities: bb debug [eca|system|tools|menu]"
   :requires ([ouroboros.debug :as dbg])
   :task (case (first *command-line-args*)
           ("eca" nil) (let [s (dbg/eca-status)]
                         (println "\n=== ECA ===")
                         (if (:exists? s)
                           (do (println "✓" (:path s) "(" (:version s) ")")
                               (println "\nECA is ready for AI chat features."))
                           (do (println "✗ Not found at" (:path s))
                               (println "\n⚠️  ECA is required for AI chat.")
                               (println "   Install: bb setup:eca"))))
           ("system" "status") (dbg/system-status)
           ("tools") (dbg/tool-registry)
           ("menu" "help") (dbg/debug-menu)
           (println "Usage: bb debug [eca|system|tools|menu]"))}

  ;; === λ(system) Metrics & Maintenance ===

  lambda:metrics
  {:doc "Show λ(system) effectiveness metrics"
   :requires ([ouroboros.lambda-metrics :as lambda])
   :task (lambda/lambda-system-report)}

  lambda:maintain
  {:doc "Run λ(system) maintenance checklist"
   :requires ([ouroboros.lambda-maintain :as maintain])
   :task (maintain/run-checklist!)}

    lambda:evolve
    {:doc "Run λ(system) auto-evolution"
     :requires ([ouroboros.lambda-evolve :as evolve])
     :task (evolve/auto-evolve!)}

    lambda:evolve:status
    {:doc "Show λ(system) evolution status"
     :requires ([ouroboros.lambda-evolve :as evolve])
     :task (do
             (println "\n=== λ(system) Status ===")
             (let [status (evolve/system-status)
                   ooda (evolve/analyze-ooda)]
               (println "\n--- Tracking ---")
               (println "Issues:" (:issues status))
               (println "Searches:" (:searches status))
               (println "Accesses:" (:accesses status))
               (println "Insights:" (:insights status))
               (println "\n--- OODA Observations ---")
               (println "Syntax:" (:syntax ooda))
               (println "Semantic:" (:semantic ooda))
               (println "Architectural:" (:architectural ooda))
               (println "Process:" (:process ooda))
               (println "")
               {:status status :ooda ooda}))}
  
      lambda:cron
      {:doc "Run λ(system) scheduled maintenance (evolve + checklist)"
       :requires ([ouroboros.lambda-evolve :as evolve]
                  [ouroboros.lambda-maintain :as maintain])
       :task (do (println "\n=== λ(system) Scheduled Maintenance ===")
                 (let [ev (evolve/auto-evolve!)
                       ch (maintain/run-checklist!)]
                   (println "\n✓ Maintenance complete")
                                      {:evolution ev :checklist ch}))}
                   
                       learning:gaps
                       {:doc "Detect learning gaps for all users"
                        :requires ([ouroboros.learning.cli :as cli])
                        :task (cli/gaps-task)}
                   
                       learning:stats
                       {:doc "Show learning statistics"
                        :requires ([ouroboros.learning.cli :as cli])
                        :task (cli/stats-task)}

                       learning:list
                       {:doc "List all learnings"
                        :requires ([ouroboros.learning.cli :as cli])
                        :task (cli/list-task)}

                       learning:recall
                       {:doc "Recall learnings by pattern"
                        :requires ([ouroboros.learning.cli :as cli])
                        :task (let [pattern (or (first *command-line-args*) \"\")]
                                (cli/recall-task pattern))}

                       learning:reindex
                       {:doc "Rebuild learning index"
                        :requires ([ouroboros.learning.cli :as cli])
                        :task (cli/rebuild-index-task)}
                       
                       prometheus
      {:doc "Start Prometheus metrics server"
       :requires ([ouroboros.telemetry.prometheus :as prom])
       :task (let [port (or (first *command-line-args*) 9090)]
               (prom/start-server! (Integer/parseInt (str port))))}
    
      prometheus:export
      {:doc "Export λ(system) metrics in Prometheus format"
       :requires ([ouroboros.telemetry.prometheus :as prom])
       :task (println (prom/metrics-text))}}}
